<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PKR DASC stacked keogram 2025-10</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #111;
      color: #eee;
      margin: 0;
      padding: 1rem;
    }
    h1 {
      margin-top: 0;
    }
    #container {
      position: relative;
      display: inline-block;
      border: 1px solid #444;
    }
    #keogram {
      max-width: 100%;
      height: auto;
      display: block;
      cursor: crosshair;
    }
    #info {
      margin-top: 0.75rem;
      font-size: 0.9rem;
      color: #ccc;
      white-space: pre-line;
    }
    #info strong {
      color: #fff;
    }
    #hover-tooltip {
        position: absolute;
        padding: 2px 6px;
        font-size: 12px;
        background: rgba(0, 0, 0, 0.85);
        color: #fff;
        border-radius: 3px;
        pointer-events: none;
        opacity: 0;
        transform: translate(8px, 8px);
        transition: opacity 0.05s linear;
        z-index: 20;
    }

  </style>
</head>
<body>
  <h1>PKR stacked keogram – October 2025</h1>
  <p>Click anywhere on the stacked keogram to open the corresponding all-sky movie ~15 minutes before that time (UT).</p>

  <div id="keogram-container" style="position: relative; display: inline-block;">
    <img
      id="keogram"
      src="stacked_keograms_202510.png"
      alt="PKR DASC stacked keogram"
    >
    <canvas
      id="keogram-overlay"
      style="position: absolute; top: 0; left: 0; pointer-events: none;"
    ></canvas>
  </div>

  <div id="hover-tooltip"></div>

  <div id="info">
    Click on the image to select a day and time.
  </div>

  <video id="player" style="display:none;"></video>

  <script>
    const YEAR = 2025;
    const MONTH = 10;

    const keogramMeta = {
      "year": 2025,
      "month": 10,
      "days": [
        {
          "ymd": "20251001",
          "day": 1,
          "h0": 4.0,
          "h1": 16.0,
          "has_video": true
        },
        {
          "ymd": "20251002",
          "day": 2,
          "h0": 3.0,
          "h1": 16.0,
          "has_video": true
        },
        {
          "ymd": "20251003",
          "day": 3,
          "h0": 3.0,
          "h1": 16.0,
          "has_video": true
        },
        {
          "ymd": "20251004",
          "day": 4,
          "h0": 3.0,
          "h1": 16.0,
          "has_video": true
        },
        {
          "ymd": "20251005",
          "day": 5,
          "h0": 3.0,
          "h1": 16.0,
          "has_video": true
        },
        {
          "ymd": "20251006",
          "day": 6,
          "h0": 3.0,
          "h1": 16.0,
          "has_video": true
        },
        {
          "ymd": "20251007",
          "day": 7,
          "h0": 3.0,
          "h1": 16.0,
          "has_video": true
        },
        {
          "ymd": "20251008",
          "day": 8,
          "h0": 3.0,
          "h1": 7.0,
          "has_video": true
        },
        {
          "ymd": "20251009",
          "day": 9,
          "h0": 3.0,
          "h1": 6.0,
          "has_video": true
        },
        {
          "ymd": "20251010",
          "day": 10,
          "h0": 3.0,
          "h1": 16.0,
          "has_video": true
        },
        {
          "ymd": "20251011",
          "day": 11,
          "h0": 3.0,
          "h1": 16.0,
          "has_video": true
        },
        {
          "ymd": "20251012",
          "day": 12,
          "h0": 3.0,
          "h1": 16.0,
          "has_video": true
        },
        {
          "ymd": "20251013",
          "day": 13,
          "h0": 3.0,
          "h1": 16.0,
          "has_video": true
        },
        {
          "ymd": "20251015",
          "day": 15,
          "h0": 3.0,
          "h1": 16.0,
          "has_video": true
        },
        {
          "ymd": "20251016",
          "day": 16,
          "h0": 3.0,
          "h1": 17.0,
          "has_video": true
        },
        {
          "ymd": "20251017",
          "day": 17,
          "h0": 3.0,
          "h1": 8.0,
          "has_video": true
        },
        {
          "ymd": "20251019",
          "day": 19,
          "h0": 3.0,
          "h1": 17.0,
          "has_video": true
        },
        {
          "ymd": "20251020",
          "day": 20,
          "h0": 2.0,
          "h1": 17.0,
          "has_video": true
        },
        {
          "ymd": "20251021",
          "day": 21,
          "h0": 2.0,
          "h1": 17.0,
          "has_video": true
        },
        {
          "ymd": "20251022",
          "day": 22,
          "h0": 2.0,
          "h1": 17.0,
          "has_video": true
        },
        {
          "ymd": "20251023",
          "day": 23,
          "h0": 2.0,
          "h1": 17.0,
          "has_video": true
        },
        {
          "ymd": "20251024",
          "day": 24,
          "h0": 2.0,
          "h1": 17.0,
          "has_video": true
        },
        {
          "ymd": "20251025",
          "day": 25,
          "h0": 2.0,
          "h1": 17.0,
          "has_video": true
        },
        {
          "ymd": "20251026",
          "day": 26,
          "h0": 2.0,
          "h1": 17.0,
          "has_video": true
        },
        {
          "ymd": "20251027",
          "day": 27,
          "h0": 2.0,
          "h1": 17.0,
          "has_video": true
        },
        {
          "ymd": "20251028",
          "day": 28,
          "h0": 2.0,
          "h1": 17.0,
          "has_video": true
        },
        {
          "ymd": "20251029",
          "day": 29,
          "h0": 2.0,
          "h1": 12.0,
          "has_video": true
        },
        {
          "ymd": "20251030",
          "day": 30,
          "h0": 2.0,
          "h1": 17.0,
          "has_video": true
        }
      ],
      "global_min_hour": 2.0,
      "global_max_hour": 17.0
    };

    const videoMeta = {
      "year": 2025,
      "month": 10,
      "videos": [
        {
          "ymd": "20251001",
          "video_file": "PKR_DASC_20251001_rgb_512.mp4",
          "start_utc": "2025-10-01T04:03:34Z",
          "end_utc": "2025-10-01T15:16:35Z"
        },
        {
          "ymd": "20251002",
          "video_file": "PKR_DASC_20251002_rgb_512.mp4",
          "start_utc": "2025-10-02T04:00:10Z",
          "end_utc": "2025-10-02T15:15:40Z"
        },
        {
          "ymd": "20251003",
          "video_file": "PKR_DASC_20251003_rgb_512.mp4",
          "start_utc": "2025-10-03T03:56:18Z",
          "end_utc": "2025-10-03T15:22:34Z"
        },
        {
          "ymd": "20251004",
          "video_file": "PKR_DASC_20251004_rgb_512.mp4",
          "start_utc": "2025-10-04T03:52:38Z",
          "end_utc": "2025-10-04T15:25:37Z"
        },
        {
          "ymd": "20251005",
          "video_file": "PKR_DASC_20251005_rgb_512.mp4",
          "start_utc": "0925-10-05T03:50:31Z",
          "end_utc": "0925-10-05T15:28:40Z"
        },
        {
          "ymd": "20251006",
          "video_file": "PKR_DASC_20251006_rgb_512.mp4",
          "start_utc": "2025-10-06T03:45:24Z",
          "end_utc": "2025-10-06T15:29:44Z"
        },
        {
          "ymd": "20251007",
          "video_file": "PKR_DASC_20251007_rgb_512.mp4",
          "start_utc": "2025-10-07T03:42:41Z",
          "end_utc": "2025-10-07T15:34:28Z"
        },
        {
          "ymd": "20251008",
          "video_file": "PKR_DASC_20251008_rgb_512.mp4",
          "start_utc": "2025-10-08T03:38:17Z",
          "end_utc": "2025-10-08T05:59:48Z"
        },
        {
          "ymd": "20251009",
          "video_file": "PKR_DASC_20251009_rgb_512.mp4",
          "start_utc": "2025-10-09T03:36:35Z",
          "end_utc": "2025-10-09T05:33:57Z"
        },
        {
          "ymd": "20251010",
          "video_file": "PKR_DASC_20251010_rgb_512.mp4",
          "start_utc": "2025-10-10T03:32:38Z",
          "end_utc": "2025-10-10T15:43:17Z"
        },
        {
          "ymd": "20251011",
          "video_file": "PKR_DASC_20251011_rgb_512.mp4",
          "start_utc": "2025-10-11T03:31:37Z",
          "end_utc": "2025-10-11T15:46:49Z"
        },
        {
          "ymd": "20251012",
          "video_file": "PKR_DASC_20251012_rgb_512.mp4",
          "start_utc": "2025-10-12T03:24:11Z",
          "end_utc": "2025-10-12T15:49:41Z"
        },
        {
          "ymd": "20251013",
          "video_file": "PKR_DASC_20251013_rgb_512.mp4",
          "start_utc": "2025-10-13T03:20:42Z",
          "end_utc": "2025-10-13T15:34:18Z"
        },
        {
          "ymd": "20251015",
          "video_file": "PKR_DASC_20251015_rgb_512.mp4",
          "start_utc": "2025-10-15T03:14:43Z",
          "end_utc": "2025-10-15T15:58:43Z"
        },
        {
          "ymd": "20251016",
          "video_file": "PKR_DASC_20251016_rgb_512.mp4",
          "start_utc": "2025-10-16T03:11:36Z",
          "end_utc": "2025-10-16T16:01:46Z"
        },
        {
          "ymd": "20251017",
          "video_file": "PKR_DASC_20251017_rgb_512.mp4",
          "start_utc": "2025-10-17T03:08:05Z",
          "end_utc": "2025-10-17T07:44:29Z"
        },
        {
          "ymd": "20251019",
          "video_file": "PKR_DASC_20251019_rgb_512.mp4",
          "start_utc": "2025-10-19T03:03:08Z",
          "end_utc": "2025-10-19T16:10:49Z"
        },
        {
          "ymd": "20251020",
          "video_file": "PKR_DASC_20251020_rgb_512.mp4",
          "start_utc": "2025-10-20T03:02:49Z",
          "end_utc": "2025-10-20T16:07:52Z"
        },
        {
          "ymd": "20251021",
          "video_file": "PKR_DASC_20251021_rgb_512.mp4",
          "start_utc": "2025-10-21T02:58:46Z",
          "end_utc": "2025-10-21T16:14:44Z"
        },
        {
          "ymd": "20251022",
          "video_file": "PKR_DASC_20251022_rgb_512.mp4",
          "start_utc": "2025-10-22T02:50:12Z",
          "end_utc": "2025-10-22T16:17:26Z"
        },
        {
          "ymd": "20251023",
          "video_file": "PKR_DASC_20251023_rgb_512.mp4",
          "start_utc": "2025-10-23T02:54:34Z",
          "end_utc": "2025-10-23T16:20:28Z"
        },
        {
          "ymd": "20251024",
          "video_file": "PKR_DASC_20251024_rgb_512.mp4",
          "start_utc": "2025-10-24T02:43:38Z",
          "end_utc": "2025-10-24T16:23:44Z"
        },
        {
          "ymd": "20251025",
          "video_file": "PKR_DASC_20251025_rgb_512.mp4",
          "start_utc": "2025-10-25T02:40:23Z",
          "end_utc": "2025-10-25T16:24:15Z"
        },
        {
          "ymd": "20251026",
          "video_file": "PKR_DASC_20251026_rgb_512.mp4",
          "start_utc": "2025-10-26T02:41:46Z",
          "end_utc": "2025-10-26T16:30:42Z"
        },
        {
          "ymd": "20251027",
          "video_file": "PKR_DASC_20251027_rgb_512.mp4",
          "start_utc": "2025-10-27T02:34:00Z",
          "end_utc": "2025-10-27T16:29:46Z"
        },
        {
          "ymd": "20251028",
          "video_file": "PKR_DASC_20251028_rgb_512.mp4",
          "start_utc": "2025-10-28T02:30:50Z",
          "end_utc": "2025-10-28T16:36:59Z"
        },
        {
          "ymd": "20251029",
          "video_file": "PKR_DASC_20251029_rgb_512.mp4",
          "start_utc": "2025-10-29T02:27:40Z",
          "end_utc": "2025-10-29T11:36:54Z"
        },
        {
          "ymd": "20251030",
          "video_file": "PKR_DASC_20251030_rgb_512.mp4",
          "start_utc": "2025-10-30T02:30:06Z",
          "end_utc": "2025-10-30T16:43:54Z"
        }
      ]
    };

    const videoBase = "https://optics.gi.alaska.edu/realtime/data/MPEG/PKR_DASC_512/";

    const img       = document.getElementById("keogram");
    const overlay   = document.getElementById("keogram-overlay");
    const container = document.getElementById("keogram-container");
    const infoBox   = document.getElementById("info");
    const tooltip   = document.getElementById("hover-tooltip");

    function init() {
      const img       = document.getElementById("keogram");
      const infoBox   = document.getElementById("info");
      const tooltip   = document.getElementById("hover-tooltip");
      const player    = document.getElementById("player");

      if (!img || !infoBox || !tooltip || !player) {
        console.error("Missing DOM elements needed for init().");
        return;
      }

      const videoByYmd = {};
      if (videoMeta && Array.isArray(videoMeta.videos)) {
        for (const v of videoMeta.videos) {
          const key = String(v.ymd);
          videoByYmd[key] = v;
        }
      }
      console.log("Video entries by day:", Object.keys(videoByYmd));

      const rawH0 = keogramMeta.global_h0 ?? keogramMeta.global_min_hour ?? 0;
      const rawH1 = keogramMeta.global_h1 ?? keogramMeta.global_max_hour ?? 24;

      let globalH0 = Number(rawH0);
      let globalH1 = Number(rawH1);

      console.log(
        "Global hour range from meta (raw):",
        rawH0,
        rawH1,
        " -> parsed:",
        globalH0,
        globalH1
      );

      if (!Number.isFinite(globalH0) || !Number.isFinite(globalH1) || globalH0 >= globalH1) {
        console.warn("Global hour values invalid; defaulting to 0–24.");
        globalH0 = 0;
        globalH1 = 24;
      }

      const days    = keogramMeta.days;
      const numRows = days.length;

      function handleClick(ev) {
        const rect   = img.getBoundingClientRect();
        const clickX = ev.clientX - rect.left;
        const clickY = ev.clientY - rect.top;

        const relX = clickX / rect.width;
        const relY = clickY / rect.height;

        let rowFloat = relY * numRows;
        let rowIndex = Math.round(rowFloat - 0.5);
        if (rowIndex < 0) rowIndex = 0;
        if (rowIndex >= numRows) rowIndex = numRows - 1;

        const dayEntry = days[rowIndex];
        const ymd      = String(dayEntry.ymd);

        console.log("Click mapping:", {
          clickX: clickX.toFixed(1),
          clickY: clickY.toFixed(1),
          relX: relX.toFixed(3),
          relY: relY.toFixed(3),
          rowFloat: rowFloat.toFixed(3),
          rowIndex,
          ymd
        });

        if (!/^\d{8}$/.test(ymd)) {
          console.error("Bad ymd format:", ymd);
          alert("Internal error: bad date code " + ymd);
          return;
        }

        const fracHour      = globalH0 + relX * (globalH1 - globalH0);
        const hourInt       = Math.floor(fracHour);
        const minutesFloat  = (fracHour - hourInt) * 60;
        const minuteInt     = Math.floor(minutesFloat);
        const secondsFloat  = (minutesFloat - minuteInt) * 60;
        let   secondInt     = Math.round(secondsFloat);

        let h = hourInt;
        let m = minuteInt;
        let s = secondInt;

        if (s >= 60) {
          s -= 60;
          m += 1;
        }
        if (m >= 60) {
          m -= 60;
          h += 1;
        }

        const year     = parseInt(ymd.slice(0, 4), 10);
        const monthIdx = parseInt(ymd.slice(4, 6), 10) - 1;
        const day      = parseInt(ymd.slice(6, 8), 10);

        const clickMs = Date.UTC(year, monthIdx, day, h, m, s);
        if (!Number.isFinite(clickMs)) {
          console.error("Invalid clickMs from date pieces:", { year, monthIdx, day, h, m, s });
          alert("Internal error computing click time – see console.");
          return;
        }

        const vid = videoByYmd[ymd];
        if (!vid) {
          console.warn("No video entry for day", ymd);
          alert("No video available for this day (" + ymd + ").");
          return;
        }

        const videoStartMs = Date.parse(vid.start_utc);
        const videoEndMs   = Date.parse(vid.end_utc);
        if (!Number.isFinite(videoStartMs) || !Number.isFinite(videoEndMs) || videoEndMs <= videoStartMs) {
          console.error("Bad video timestamps for", ymd, vid);
          alert("Video metadata for " + ymd + " is incomplete.");
          return;
        }

        const realSpanMs = videoEndMs - videoStartMs;

        const HALF_WINDOW_MIN = 15;
        let windowStartMs = clickMs - HALF_WINDOW_MIN * 60 * 1000;
        let windowEndMs   = clickMs + HALF_WINDOW_MIN * 60 * 1000;

        if (windowStartMs < videoStartMs) windowStartMs = videoStartMs;
        if (windowEndMs > videoEndMs)     windowEndMs   = videoEndMs;
        if (windowEndMs < windowStartMs)  windowEndMs   = windowStartMs;

        const startRawPos  = (windowStartMs - videoStartMs) / realSpanMs;
        const endRawPos    = (windowEndMs   - videoStartMs) / realSpanMs;
        const startNormPos = Math.min(1, Math.max(0, startRawPos));
        const endNormPos   = Math.min(1, Math.max(0, endRawPos));

        const clickIso    = new Date(clickMs).toISOString();
        const winStartIso = new Date(windowStartMs).toISOString();
        const winEndIso   = new Date(windowEndMs).toISOString();
        const startIso    = new Date(videoStartMs).toISOString();
        const endIso      = new Date(videoEndMs).toISOString();

        console.log("Time mapping (window):", {
          ymd,
          clickIso,
          winStartIso,
          winEndIso,
          startIso,
          endIso,
          realSpanSec: realSpanMs / 1000,
          startNormPos,
          endNormPos
        });

        const clickDate = new Date(clickMs);
        const HH = clickDate.getUTCHours().toString().padStart(2, "0");
        const MM = clickDate.getUTCMinutes().toString().padStart(2, "0");
        const SS = clickDate.getUTCSeconds().toString().padStart(2, "0");

        infoBox.textContent =
          "Day " + ymd +
          " | clicked UT ≈ " + HH + ":" + MM + ":" + SS +
          "\nVideo: " + vid.video_file +
          "\nWindow ≈ [ " + winStartIso + "  →  " + winEndIso + " ] (UT, ~" +
          (2 * HALF_WINDOW_MIN) + " min span).";

        const videoUrl = videoBase + vid.video_file;

        player.pause();
        player.removeAttribute("src");
        player.load();

        player.src = videoUrl;
        player.load();

        player.onloadedmetadata = () => {
          const duration = player.duration;

          let startSec = 0;
          let endSec   = duration;

          if (Number.isFinite(duration) && duration > 0) {
            startSec = startNormPos * duration;
            endSec   = endNormPos   * duration;

            if (endSec < startSec + 0.5) {
              endSec = Math.min(duration, startSec + 0.5);
            }
          }

          console.log("Video metadata loaded for #t fragment:", {
            duration,
            startNormPos,
            endNormPos,
            startSec,
            endSec
          });

          const openUrl =
            videoUrl +
            "#t=" +
            startSec.toFixed(1) + "," +
            endSec.toFixed(1);

          window.open(openUrl, "_blank");
        };
      }

      function handleMouseMove(ev) {
        const rect = img.getBoundingClientRect();
        const x    = ev.clientX - rect.left;
        const y    = ev.clientY - rect.top;

        const relX = x / rect.width;
        const relY = y / rect.height;

        let rowFloat = relY * numRows;
        let rowIndex = Math.round(rowFloat - 0.5);
        if (rowIndex < 0) rowIndex = 0;
        if (rowIndex >= numRows) rowIndex = numRows - 1;

        const dayEntry = days[rowIndex];
        const ymd      = String(dayEntry.ymd);
        if (!/^\d{8}$/.test(ymd)) {
          return;
        }

        const fracHour      = globalH0 + relX * (globalH1 - globalH0);
        const hourInt       = Math.floor(fracHour);
        const minutesFloat  = (fracHour - hourInt) * 60;
        const minuteInt     = Math.floor(minutesFloat);
        const secondsFloat  = (minutesFloat - minuteInt) * 60;
        let   secondInt     = Math.round(secondsFloat);

        let h = hourInt;
        let m = minuteInt;
        let s = secondInt;

        if (s >= 60) {
          s -= 60;
          m += 1;
        }
        if (m >= 60) {
          m -= 60;
          h += 1;
        }

        const year     = parseInt(ymd.slice(0, 4), 10);
        const monthIdx = parseInt(ymd.slice(4, 6), 10) - 1;
        const day      = parseInt(ymd.slice(6, 8), 10);

        const hoverMs   = Date.UTC(year, monthIdx, day, h, m, s);
        const hoverDate = new Date(hoverMs);

        const Y  = hoverDate.getUTCFullYear();
        const M  = (hoverDate.getUTCMonth() + 1).toString().padStart(2, "0");
        const D  = hoverDate.getUTCDate().toString().padStart(2, "0");
        const HH = hoverDate.getUTCHours().toString().padStart(2, "0");
        const MM = hoverDate.getUTCMinutes().toString().padStart(2, "0");
        const SS = hoverDate.getUTCSeconds().toString().padStart(2, "0");

        const label = `${Y}-${M}-${D} ${HH}:${MM}:${SS} UT`;

        tooltip.textContent   = label;
        tooltip.style.left    = `${ev.pageX}px`;
        tooltip.style.top     = `${ev.pageY}px`;
        tooltip.style.opacity = "1";
      }

      function initAfterImageLoads() {
        img.addEventListener("click", handleClick);
        img.addEventListener("mousemove", handleMouseMove);
        img.addEventListener("mouseleave", () => {
          tooltip.style.opacity = "0";
        });
      }

      if (img.complete) {
        initAfterImageLoads();
      } else {
        img.addEventListener("load", initAfterImageLoads);
      }

      console.log("Keogram interactive init complete.");
    }

    init();

  </script>
</body>
</html>
